import streamlit as st
import pandas as pd
from io import BytesIO

st.title('Conversion Rate & Upsell Rate Analyzer')

# –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Ñ–∞–π–ª–∏
st.header('1. –ó–∞—Ä–µ–¥–µ—Ç–µ —Å–∏ –¥–≤–∞—Ç–∞ —Ñ–∞–π–ª–∞')
sales_file = st.file_uploader("–ó–∞—Ä–µ–¥–∏ Excel —Å–ø—Ä–∞–≤–∫–∞ —Å –ø—Ä–æ–¥–∞–∂–±–∏", type=["xlsx"])
visits_file = st.file_uploader("–ó–∞—Ä–µ–¥–∏ CSV —Ñ–∞–π–ª —Å –ø–æ—Å–µ—â–µ–Ω–∏—è", type=["csv"])

if sales_file and visits_file:

    sales_data = pd.read_excel(sales_file)

    # –ó–∞—Ä–µ–∂–¥–∞–Ω–µ —Å–∞–º–æ –Ω–∞ –ø—ä—Ä–≤–∏—Ç–µ –¥–≤–µ –∫–æ–ª–æ–Ω–∏ –æ—Ç CSV (–±–µ–∑ –∏–º–µ–Ω–∞)
    visits_data = pd.read_csv(visits_file, header=None, usecols=[0, 1], names=['–î–µ–Ω', '–ü–æ—Å–µ—â–µ–Ω–∏—è'])

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–≤–∞–Ω–µ –Ω–∞ –¥–µ–Ω—è –≤ –¥–∞—Ç–∞
    visits_data['–î–µ–Ω'] = visits_data['–î–µ–Ω'].astype(int)

    # –í–∑–µ–º–∞–º–µ –∏ –º–µ—Å–µ—Ü–∞/–≥–æ–¥–∏–Ω–∞—Ç–∞ –æ—Ç —Ñ–∞–π–ª–∞ —Å –ø—Ä–æ–¥–∞–∂–±–∏
    # –ó–∞ –¥–∞ –º–æ–∂–µ–º –¥–∞ –ø–æ—Å—Ç—Ä–æ–∏–º –¥–∞—Ç–∞ –æ—Ç –¥–µ–Ω
    first_date = sales_data['–û—Ç –¥–∞—Ç–∞'].min()
    year = first_date.year
    month = first_date.month

    # –°—ä–∑–¥–∞–≤–∞–º–µ –ø—ä–ª–Ω–∞ –¥–∞—Ç–∞ –∑–∞ –≤—Å—è–∫–æ –ø–æ—Å–µ—â–µ–Ω–∏–µ
    visits_data['–î–∞—Ç–∞'] = pd.to_datetime({
        'year': year,
        'month': month,
        'day': visits_data['–î–µ–Ω']
    })

    # –§–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ
    sales_data['–û—Ç –¥–∞—Ç–∞'] = pd.to_datetime(sales_data['–û—Ç –¥–∞—Ç–∞'])
    sales_data['–î–µ–Ω'] = sales_data['–û—Ç –¥–∞—Ç–∞'].dt.date
    visits_data['–î–µ–Ω'] = visits_data['–î–∞—Ç–∞'].dt.date

    # –ê–≥—Ä–µ–≥–∏—Ä–∞–Ω–µ –Ω–∞ –ø–æ—Å–µ—â–µ–Ω–∏—è –ø–æ –¥–µ–Ω
    daily_visits = visits_data.groupby('–î–µ–Ω')['–ü–æ—Å–µ—â–µ–Ω–∏—è'].sum().reset_index()

    # –°–ª–∏–≤–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ
    merged_data = pd.merge(sales_data, daily_visits, on='–î–µ–Ω', how='left')

    # –ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –∫–æ–Ω–≤—ä—Ä—à—ä–Ω —Ä–µ–π—Ç
    merged_data['Conversion Rate (%)'] = (merged_data['–ü—Ä–æ–¥–∞–∂–±–∏'] / merged_data['–ü–æ—Å–µ—â–µ–Ω–∏—è']) * 100

    # –ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ Upsell Rate
    merged_data['Upsell Rate (%)'] = (merged_data['–û–±–æ—Ä–æ—Ç –∫–æ–ª–∏—á.'] / merged_data['–ü—Ä–æ–¥–∞–∂–±–∏']) * 100

    # –ò–∑–≤–æ–¥
    st.header('2. –†–µ–∑—É–ª—Ç–∞—Ç–∏')
    st.dataframe(merged_data)

    # –°–≤–∞–ª—è–Ω–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–µ–Ω–∏—Ç–µ –¥–∞–Ω–Ω–∏
    def to_excel(df):
        output = BytesIO()
        with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
            df.to_excel(writer, index=False, sheet_name='Analysis')
        processed_data = output.getvalue()
        return processed_data

    excel_data = to_excel(merged_data)

    st.download_button(
        label="üíæ –°–≤–∞–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ –≤ Excel",
        data=excel_data,
        file_name='conversion_upsell_analysis.xlsx',
        mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )

else:
    st.warning('–ú–æ–ª—è, –∑–∞—Ä–µ–¥–µ—Ç–µ –∏ –¥–≤–∞—Ç–∞ —Ñ–∞–π–ª–∞, –∑–∞ –¥–∞ –∏–∑–≤—ä—Ä—à–∏–º –∞–Ω–∞–ª–∏–∑–∞.')
